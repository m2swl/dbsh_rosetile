<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Demo</title>

    <!-- Favicon -->
    <link rel="icon" href="favicon.ico">

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color (iOS Safari and other browsers) -->
    <meta name="theme-color" content="#9EF2B3">  <!-- manifest.jsonのtheme_colorと合わせる -->

    <!-- iOS specific meta tags for PWA (optional but good to have) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sensor Demo"> 

    <!-- Material Web Components (MWC) - CDNから読み込み -->
    <script type="module" src="https://unpkg.com/@material/web/all.js?module"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Noto Sans JP from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Style -->
    <link href="style.css" rel="stylesheet">
</head>

<body data-theme="light"> 
    <div class="app-bar">
        <h1>Sensor Demo</h1>
        <div class="theme-switch-container">
            <md-icon>light_mode</md-icon>
            <md-switch id="themeSwitch"></md-switch>
            <md-icon>dark_mode</md-icon>
        </div>
    </div>

    <div class="app-container">
        <div id="permissionButtonContainer">
            <!-- iOS Safariなどでセンサー許可を促すボタンがここに追加されます -->
        </div>

        <!-- Recording Card -->
        <md-card>
            <div class="card-header">
                <md-icon>fiber_manual_record</md-icon>
                <h2>データ記録 (CSV)</h2>
            </div>
            <div class="card-content">
                <div class="recording-controls">
                    <md-filled-button id="startRecordingButton">
                        <md-icon slot="icon">play_arrow</md-icon>
                        記録開始
                    </md-filled-button>
                    <md-outlined-button id="stopRecordingButton" disabled>
                        <md-icon slot="icon">stop</md-icon>
                        記録停止
                    </md-outlined-button>
                    <md-filled-button id="downloadCSVButton" disabled>
                        <md-icon slot="icon">download</md-icon>
                        CSVダウンロード
                    </md-filled-button>
                </div>
                <p class="status-text" id="recordingStatus">待機中。センサーアクセスを許可してください。</p>
            </div>
        </md-card>


        <!-- Device Orientation Card -->
        <md-card>
            <div class="card-header">
                <md-icon>screen_rotation</md-icon>
                <h2>デバイスの向き</h2>
            </div>
            <div class="card-content">
                <div class="cube-container">
                    <div class="cube" id="orientationCube">
                        <div class="cube__face cube__face--front">前</div>
                        <div class="cube__face cube__face--back">後</div>
                        <div class="cube__face cube__face--right">右</div>
                        <div class="cube__face cube__face--left">左</div>
                        <div class="cube__face cube__face--top">上</div>
                        <div class="cube__face cube__face--bottom">下</div>
                    </div>
                </div>
                <p class="sensor-value"><strong>Alpha (Z軸):</strong> <span id="orient-alpha">-</span> °</p>
                <p class="sensor-value"><strong>Beta (X軸):</strong> <span id="orient-beta">-</span> °</p>
                <p class="sensor-value"><strong>Gamma (Y軸):</strong> <span id="orient-gamma">-</span> °</p>
                <p class="status-text" id="orient-status">待機中...</p>
            </div>
        </md-card>

        <!-- Accelerometer Card -->
        <md-card>
            <div class="card-header">
                <md-icon>vibration</md-icon>
                <h2>加速度 (重力含む)</h2>
            </div>
            <div class="card-content">
                <div class="bars-container">
                    <div class="bar" id="accel-bar-x"><span class="bar-label">X</span></div>
                    <div class="bar" id="accel-bar-y"><span class="bar-label">Y</span></div>
                    <div class="bar" id="accel-bar-z"><span class="bar-label">Z</span></div>
                </div>
                <p class="sensor-value"><strong>X:</strong> <span id="accel-x">-</span> m/s²</p>
                <p class="sensor-value"><strong>Y:</strong> <span id="accel-y">-</span> m/s²</p>
                <p class="sensor-value"><strong>Z:</strong> <span id="accel-z">-</span> m/s²</p>
                <p class="status-text" id="accel-status">待機中...</p>
            </div>
        </md-card>
        
        <!-- Gyroscope Card -->
        <md-card>
            <div class="card-header">
                <md-icon>explore</md-icon> 
                <h2>ジャイロスコープ (回転速度)</h2>
            </div>
            <div class="card-content">
                <p class="sensor-value"><strong>Alpha (Z軸):</strong> <span id="gyro-alpha">-</span> °/s</p>
                <p class="sensor-value"><strong>Beta (X軸):</strong> <span id="gyro-beta">-</span> °/s</p>
                <p class="sensor-value"><strong>Gamma (Y軸):</strong> <span id="gyro-gamma">-</span> °/s</p>
                <p class="status-text" id="gyro-status">待機中...</p>
            </div>
        </md-card>

        <!-- Light Sensor Card -->
        <md-card>
            <div class="card-header">
                <md-icon>lightbulb</md-icon>
                <h2>光センサー</h2>
            </div>
            <div class="card-content">
                <div class="light-viz">
                    <md-icon id="light-icon-sun" style="display:none;">wb_sunny</md-icon>
                    <md-icon id="light-icon-moon" style="display:none;">nightlight_round</md-icon>
                </div>
                <p class="sensor-value"><strong>明るさ:</strong> <span id="light-value">-</span> lux</p>
                <p class="status-text" id="light-status">待機中...</p>
            </div>
        </md-card>

        <p style="font-size: 0.8em; text-align: center; margin-top: 20px; color: var(--md-sys-color-on-surface-variant);">
            注意: センサーの利用にはブラウザからの許可が必要な場合があります。また、お使いのデバイスやブラウザによっては一部センサーが利用できないことがあります。記録されたデータはCSV形式でダウンロードできます。
        </p>
    </div>

    <script type="module">
        // MWCコンポーネントの参照 (all.jsを読み込んでいるので個別のimportは不要)
        
        // DOM Elements
        const body = document.body;
        const themeSwitch = document.getElementById('themeSwitch');
        const permissionButtonContainer = document.getElementById('permissionButtonContainer');

        // Recording Elements
        const startRecordingButton = document.getElementById('startRecordingButton');
        const stopRecordingButton = document.getElementById('stopRecordingButton');
        const downloadCSVButton = document.getElementById('downloadCSVButton');
        const recordingStatusEl = document.getElementById('recordingStatus');

        // Orientation
        const orientationCube = document.getElementById('orientationCube');
        const orientAlphaEl = document.getElementById('orient-alpha');
        const orientBetaEl = document.getElementById('orient-beta');
        const orientGammaEl = document.getElementById('orient-gamma');
        const orientStatusEl = document.getElementById('orient-status');

        // Accelerometer
        const accelXEl = document.getElementById('accel-x');
        const accelYEl = document.getElementById('accel-y');
        const accelZEl = document.getElementById('accel-z');
        const accelStatusEl = document.getElementById('accel-status');
        const accelBarX = document.getElementById('accel-bar-x');
        const accelBarY = document.getElementById('accel-bar-y');
        const accelBarZ = document.getElementById('accel-bar-z');
        const BAR_MAX_ACCEL = 20; // m/s^2 (バーの最大値の目安、デバイスによって調整)

        // Gyroscope
        const gyroAlphaEl = document.getElementById('gyro-alpha');
        const gyroBetaEl = document.getElementById('gyro-beta');
        const gyroGammaEl = document.getElementById('gyro-gamma');
        const gyroStatusEl = document.getElementById('gyro-status');

        // Light Sensor
        const lightValueEl = document.getElementById('light-value');
        const lightStatusEl = document.getElementById('light-status');
        const lightIconSun = document.getElementById('light-icon-sun');
        const lightIconMoon = document.getElementById('light-icon-moon');

        // --- Recording Variables ---
        let isRecording = false;
        let recordedData = [];
        let recordingIntervalId = null;
        const RECORDING_INTERVAL_MS = 100; // 100ms ごとにデータを記録 (10Hz)
        let currentSensorValues = {
            timestamp: null,
            accelX: null, accelY: null, accelZ: null,
            orientAlpha: null, orientBeta: null, orientGamma: null,
            gyroAlpha: null, gyroBeta: null, gyroGamma: null,
            illuminance: null
        };


        // --- Theme Switch Logic ---
        function applyTheme(theme) {
            body.dataset.theme = theme;
            localStorage.setItem('theme', theme);
            if (themeSwitch) { 
                themeSwitch.selected = (theme === 'dark');
                themeSwitch.ariaLabel = theme === 'dark' ? 'ライトテーマに切り替え' : 'ダークテーマに切り替え';
            }
        }

        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const savedTheme = localStorage.getItem('theme');
        const currentTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
        applyTheme(currentTheme);

        prefersDarkScheme.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });
        
        if (themeSwitch) {
            themeSwitch.addEventListener('change', () => {
                applyTheme(themeSwitch.selected ? 'dark' : 'light');
            });
        }

        // --- Sensor Permission and Initialization ---
        let motionPermissionGranted = false;
        let orientationPermissionGranted = false;
        let sensorsInitialized = false; 
        let anySensorSupported = false; // いずれかのセンサーが利用可能か

        function updateRecordingButtonState() {
            if (!startRecordingButton) return; // DOM読み込み前は実行しない

            if (anySensorSupported) {
                startRecordingButton.disabled = isRecording;
                stopRecordingButton.disabled = !isRecording;
                downloadCSVButton.disabled = isRecording || recordedData.length === 0;
                if (isRecording) {
                    recordingStatusEl.textContent = `記録中... (${recordedData.length}件)`;
                } else if (recordedData.length > 0) {
                    recordingStatusEl.textContent = `記録停止中。${recordedData.length}件のデータを記録済み。CSVをダウンロードできます。`;
                } else if (sensorsInitialized) {
                    recordingStatusEl.textContent = "センサー監視中。記録を開始できます。";
                }
            } else {
                startRecordingButton.disabled = true;
                stopRecordingButton.disabled = true;
                downloadCSVButton.disabled = true;
                if (sensorsInitialized) { // 初期化試行後
                    recordingStatusEl.textContent = "利用可能なセンサーがないため記録できません。";
                } else {
                    recordingStatusEl.textContent = "センサーのアクセス許可待ち、または利用できません。";
                }
            }
        }


        function initializeSensors() {
            if (sensorsInitialized) return;

            anySensorSupported = false; // リセット

            // Device Motion (Accelerometer, Gyroscope)
            if (motionPermissionGranted) {
                window.addEventListener('devicemotion', handleMotionEvent, { passive: true });
                accelStatusEl.textContent = "監視中...";
                gyroStatusEl.textContent = "監視中...";
                anySensorSupported = true;
            } else if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission !== 'function') {
                window.addEventListener('devicemotion', handleMotionEvent, { passive: true });
                accelStatusEl.textContent = "監視中...";
                gyroStatusEl.textContent = "監視中...";
                motionPermissionGranted = true;
                anySensorSupported = true;
            } else if (!window.DeviceMotionEvent) {
                accelStatusEl.textContent = '加速度センサーはサポートされていません。';
                accelStatusEl.classList.add('not-supported');
                gyroStatusEl.textContent = 'ジャイロスコープはサポートされていません。';
                gyroStatusEl.classList.add('not-supported');
            }


            // Device Orientation
            if (orientationPermissionGranted) {
                window.addEventListener('deviceorientation', handleOrientationEvent, { passive: true });
                orientStatusEl.textContent = "監視中...";
                anySensorSupported = true;
            } else if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission !== 'function') {
                window.addEventListener('deviceorientation', handleOrientationEvent, { passive: true });
                orientStatusEl.textContent = "監視中...";
                orientationPermissionGranted = true;
                anySensorSupported = true;
            } else if(!window.DeviceOrientationEvent) {
                orientStatusEl.textContent = '向きセンサーはサポートされていません。';
                orientStatusEl.classList.add('not-supported');
            }
            
            initializeLightSensor(); 

            sensorsInitialized = true;
            if (permissionButtonContainer.firstChild) {
                permissionButtonContainer.firstChild.remove(); 
            }
            updateRecordingButtonState(); // 初期状態のボタンを更新
        }


        function requestSensorPermissions() {
            const promises = [];
            let needsDeviceMotionPermission = window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function';
            let needsDeviceOrientationPermission = window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function';

            if (needsDeviceMotionPermission) {
                promises.push(
                    DeviceMotionEvent.requestPermission().then(state => {
                        if (state === 'granted') {
                            motionPermissionGranted = true;
                        } else {
                            accelStatusEl.textContent = '加速度センサーへのアクセスが拒否されました。';
                            accelStatusEl.classList.add('error');
                            gyroStatusEl.textContent = 'ジャイロスコープへのアクセスが拒否されました。';
                            gyroStatusEl.classList.add('error');
                        }
                    }).catch(err => {
                        console.error("DeviceMotionEvent permission error:", err);
                        accelStatusEl.textContent = `加速度センサーエラー`;
                        accelStatusEl.classList.add('error');
                        gyroStatusEl.textContent = `ジャイロスコープエラー`;
                        gyroStatusEl.classList.add('error');
                    })
                );
            }

            if (needsDeviceOrientationPermission) {
                promises.push(
                    DeviceOrientationEvent.requestPermission().then(state => {
                        if (state === 'granted') {
                            orientationPermissionGranted = true;
                        } else {
                            orientStatusEl.textContent = '向きセンサーへのアクセスが拒否されました。';
                            orientStatusEl.classList.add('error');
                        }
                    }).catch(err => {
                        console.error("DeviceOrientationEvent permission error:", err);
                        orientStatusEl.textContent = `向きセンサーエラー`;
                        orientStatusEl.classList.add('error');
                    })
                );
            }

            if (promises.length > 0) {
                Promise.allSettled(promises).then(() => {
                    initializeSensors();
                });
            } else {
                initializeSensors();
            }
        }
        
        if ((window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') ||
            (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function')) {
            
            Promise.all([
                navigator.permissions && navigator.permissions.query({ name: "accelerometer" }).catch(()=>({state:'prompt'})),
                navigator.permissions && navigator.permissions.query({ name: "gyroscope" }).catch(()=>({state:'prompt'})),
            ]).then(() => {
                const permissionButton = document.createElement('md-filled-button');
                permissionButton.textContent = 'センサーアクセスを開始';
                permissionButton.id = 'sensorPermissionButton';
                permissionButton.addEventListener('click', requestSensorPermissions, { once: true }); 
                permissionButtonContainer.appendChild(permissionButton);

                accelStatusEl.textContent = "ボタンを押してアクセスを許可";
                gyroStatusEl.textContent = "ボタンを押してアクセスを許可";
                orientStatusEl.textContent = "ボタンを押してアクセスを許可";
                recordingStatusEl.textContent = "ボタンを押してセンサーアクセスを許可してください。";
            });

        } else {
            requestSensorPermissions();
        }

        // --- Sensor Event Handlers (Update currentSensorValues) ---
        function handleMotionEvent(event) {
            if (!motionPermissionGranted && !(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission !== 'function')) {
                return;
            }

            if (event.accelerationIncludingGravity) {
                const { x, y, z } = event.accelerationIncludingGravity;
                currentSensorValues.accelX = x;
                currentSensorValues.accelY = y;
                currentSensorValues.accelZ = z;
                accelXEl.textContent = x ? x.toFixed(2) : '-';
                accelYEl.textContent = y ? y.toFixed(2) : '-';
                accelZEl.textContent = z ? z.toFixed(2) : '-';

                requestAnimationFrame(() => { 
                    accelBarX.style.height = `${Math.min(100, (Math.abs(x || 0) / BAR_MAX_ACCEL) * 100)}%`;
                    accelBarY.style.height = `${Math.min(100, (Math.abs(y || 0) / BAR_MAX_ACCEL) * 100)}%`;
                    accelBarZ.style.height = `${Math.min(100, (Math.abs(z || 0) / BAR_MAX_ACCEL) * 100)}%`;
                });
                if (accelStatusEl.textContent !== "監視中...") accelStatusEl.textContent = "監視中...";
            } else {
                currentSensorValues.accelX = null; currentSensorValues.accelY = null; currentSensorValues.accelZ = null;
                if (accelStatusEl.classList.contains('not-supported') === false && accelStatusEl.textContent.includes("ボタンを")) {
                    accelStatusEl.textContent = '加速度データ利用不可';
                }
            }

            if (event.rotationRate) {
                const { alpha, beta, gamma } = event.rotationRate;
                currentSensorValues.gyroAlpha = alpha;
                currentSensorValues.gyroBeta = beta;
                currentSensorValues.gyroGamma = gamma;
                gyroAlphaEl.textContent = alpha ? alpha.toFixed(2) : '-';
                gyroBetaEl.textContent = beta ? beta.toFixed(2) : '-';
                gyroGammaEl.textContent = gamma ? gamma.toFixed(2) : '-';
                if (gyroStatusEl.textContent !== "監視中...") gyroStatusEl.textContent = "監視中...";
            } else {
                currentSensorValues.gyroAlpha = null; currentSensorValues.gyroBeta = null; currentSensorValues.gyroGamma = null;
                if (gyroStatusEl.classList.contains('not-supported') === false && gyroStatusEl.textContent.includes("ボタンを")) {
                    gyroStatusEl.textContent = 'ジャイロスコープデータ利用不可';
                }
            }
        }

        function handleOrientationEvent(event) {
            if (!orientationPermissionGranted && !(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission !== 'function')) {
                return;
            }
            const { alpha, beta, gamma } = event;
            currentSensorValues.orientAlpha = alpha;
            currentSensorValues.orientBeta = beta;
            currentSensorValues.orientGamma = gamma;
            orientAlphaEl.textContent = alpha ? alpha.toFixed(1) : '-';
            orientBetaEl.textContent = beta ? beta.toFixed(1) : '-';
            orientGammaEl.textContent = gamma ? gamma.toFixed(1) : '-';
            
            if (beta !== null && gamma !== null && alpha !== null) {
                requestAnimationFrame(() => {
                    orientationCube.style.transform = `rotateX(${beta.toFixed(1)}deg) rotateY(${gamma.toFixed(1)}deg) rotateZ(${alpha.toFixed(1)}deg)`;
                });
            }
            if (orientStatusEl.textContent !== "監視中...") orientStatusEl.textContent = "監視中...";
        }

        function initializeLightSensor() {
            if (!('AmbientLightSensor' in window)) {
                lightStatusEl.textContent = '光センサー API はサポートされていません。';
                lightStatusEl.classList.add('not-supported');
                currentSensorValues.illuminance = null;
                return;
            }

            lightStatusEl.textContent = "アクセス許可を待っています...";
            
            const startSensor = () => {
                try {
                    const sensor = new AmbientLightSensor({ frequency: 1 }); 
                    sensor.addEventListener('reading', () => {
                        const illuminance = sensor.illuminance;
                        currentSensorValues.illuminance = illuminance;
                        anySensorSupported = true; // 光センサーも利用可能とみなす
                        updateRecordingButtonState();

                        lightValueEl.textContent = illuminance ? illuminance.toFixed(0) : '-';
                        lightStatusEl.textContent = "監視中...";
                        lightStatusEl.classList.remove('error', 'not-supported');

                        if (illuminance === null || typeof illuminance === 'undefined') {
                            lightIconSun.style.display = 'none';
                            lightIconMoon.style.display = 'none';
                            return;
                        }
                        if (illuminance > 100) { 
                            lightIconSun.style.display = 'inline-block';
                            lightIconMoon.style.display = 'none';
                        } else if (illuminance < 10) { 
                            lightIconSun.style.display = 'none';
                            lightIconMoon.style.display = 'inline-block';
                        } else { 
                            lightIconSun.style.display = 'none';
                            lightIconMoon.style.display = 'none';
                        }
                    });
                    sensor.addEventListener('error', event => {
                        console.error("AmbientLightSensor error:", event.error);
                        currentSensorValues.illuminance = null;
                        lightValueEl.textContent = `-`;
                        if (event.error.name === 'NotAllowedError') {
                            lightStatusEl.textContent = '光センサー: アクセスが許可されていません。';
                        } else if (event.error.name === 'NotReadableError') {
                            lightStatusEl.textContent = '光センサー: センサーからデータを読み取れません。';
                        } else {
                            lightStatusEl.textContent = `光センサーエラー: ${event.error.name}`;
                        }
                        lightStatusEl.classList.add('error');
                        lightIconSun.style.display = 'none';
                        lightIconMoon.style.display = 'none';
                        updateRecordingButtonState();
                    });
                    sensor.start();
                } catch (error) {
                    console.error("AmbientLightSensor initialization error:", error);
                    currentSensorValues.illuminance = null;
                    lightValueEl.textContent = `-`;
                    if (error.name === 'SecurityError') {
                        lightStatusEl.textContent = '光センサー: 安全でないコンテキスト(非HTTPS)では利用できません。';
                    } else if (error.name === 'ReferenceError') { 
                        lightStatusEl.textContent = '光センサー: APIがブラウザでサポートされていません。';
                    } else {
                        lightStatusEl.textContent = `光センサー初期化失敗: ${error.name}`;
                    }
                    lightStatusEl.classList.add('error');
                    updateRecordingButtonState();
                }
            };
            
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'ambient-light-sensor' })
                    .then(permissionStatus => {
                        if (permissionStatus.state === 'granted') {
                            startSensor();
                        } else if (permissionStatus.state === 'prompt') {
                            lightStatusEl.textContent = '光センサー: ブラウザがアクセス許可を求めています。';
                            // ユーザーインタラクション後に呼ばれることを期待
                        } else { 
                            lightStatusEl.textContent = '光センサーへのアクセスが拒否されました。';
                            lightStatusEl.classList.add('error');
                        }
                        permissionStatus.onchange = () => { 
                            if(permissionStatus.state === 'granted') {
                                startSensor();
                            } else if (permissionStatus.state === 'denied') {
                                lightStatusEl.textContent = '光センサーへのアクセスが拒否されました。';
                                lightStatusEl.classList.add('error');
                            }
                            updateRecordingButtonState();
                        };
                    })
                    .catch(e => { 
                        console.warn("Permissions API for ambient-light-sensor not supported, trying to start sensor directly.", e);
                        startSensor(); 
                    });
            } else {
                console.warn("Permissions API not supported, trying to start ambient-light-sensor directly.");
                startSensor();
            }
        }

        // --- Recording Logic ---
        function recordCurrentData() {
            if (!isRecording) return;

            const now = Date.now();
            currentSensorValues.timestamp = now;

            // currentSensorValues のコピーを記録 (参照ではなく値)
            recordedData.push({ ...currentSensorValues });
            
            if (recordedData.length % 10 === 0) { // 1秒ごとくらいに表示更新 (10Hzの場合)
                recordingStatusEl.textContent = `記録中... (${recordedData.length}件)`;
            }
        }

        function startRecording() {
            if (!anySensorSupported) {
                recordingStatusEl.textContent = "利用可能なセンサーがないため記録を開始できません。";
                alert("利用可能なセンサーがないか、センサーへのアクセスが許可されていません。");
                return;
            }
            isRecording = true;
            recordedData = []; // 新規記録開始時にデータをクリア
            recordingStatusEl.textContent = "記録を開始しました...";
            
            // 既存のインターバルがあればクリア
            if (recordingIntervalId) {
                clearInterval(recordingIntervalId);
            }
            recordingIntervalId = setInterval(recordCurrentData, RECORDING_INTERVAL_MS);
            updateRecordingButtonState();
        }

        function stopRecording() {
            isRecording = false;
            if (recordingIntervalId) {
                clearInterval(recordingIntervalId);
                recordingIntervalId = null;
            }
            recordingStatusEl.textContent = `記録を停止しました。${recordedData.length}件のデータを記録。`;
            updateRecordingButtonState();
        }

        function downloadCSV() {
            if (recordedData.length === 0) {
                alert("記録データがありません。");
                return;
            }

            const header = "timestamp,accelX,accelY,accelZ,orientAlpha,orientBeta,orientGamma,gyroAlpha,gyroBeta,gyroGamma,illuminance";
            const rows = recordedData.map(row => {
                return [
                    row.timestamp,
                    row.accelX !== null ? row.accelX.toFixed(3) : '',
                    row.accelY !== null ? row.accelY.toFixed(3) : '',
                    row.accelZ !== null ? row.accelZ.toFixed(3) : '',
                    row.orientAlpha !== null ? row.orientAlpha.toFixed(2) : '',
                    row.orientBeta !== null ? row.orientBeta.toFixed(2) : '',
                    row.orientGamma !== null ? row.orientGamma.toFixed(2) : '',
                    row.gyroAlpha !== null ? row.gyroAlpha.toFixed(3) : '',
                    row.gyroBeta !== null ? row.gyroBeta.toFixed(3) : '',
                    row.gyroGamma !== null ? row.gyroGamma.toFixed(3) : '',
                    row.illuminance !== null ? row.illuminance.toFixed(0) : ''
                ].join(',');
            });

            const csvContent = header + "\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                const now = new Date();
                const timestampStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
                link.setAttribute("href", url);
                link.setAttribute("download", `sensor_data_${timestampStr}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                recordingStatusEl.textContent = `CSVファイルをダウンロードしました。 (${recordedData.length}件)`;
            } else {
                alert("お使いのブラウザでは自動ダウンロードがサポートされていません。");
            }
        }

        // --- Event Listeners for Recording Controls ---
        if(startRecordingButton) startRecordingButton.addEventListener('click', startRecording);
        if(stopRecordingButton) stopRecordingButton.addEventListener('click', stopRecording);
        if(downloadCSVButton) downloadCSVButton.addEventListener('click', downloadCSV);

        // 初期ボタン状態の更新
        updateRecordingButtonState();

    </script>
</body>
</html>